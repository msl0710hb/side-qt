name: Qt Cross-Platform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        # 为每个平台绑定唯一正确的 Qt 架构
        include:
          - os: macos-latest
            qt_arch: clang_64  # macOS 唯一架构（支持 Intel/M1/M2）
          - os: windows-latest
            qt_arch: win64_msvc2022_64  # Windows 唯一架构（MSVC 2022 64位）
          - os: ubuntu-latest
            qt_arch: gcc_64  # Linux 唯一架构（GCC 64位）
    runs-on: ${{ matrix.os }}

    steps:
      # 1. 检出代码
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. 安装 Qt 6.9.2（精准指定架构，无多余参数）
      - name: Install Qt 6.9.2
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.2'
          arch: ${{ matrix.qt_arch }}  # 直接使用矩阵中绑定的唯一架构
          cache: true
          aqtversion: '==3.1.21'  # 锁定 aqtinstall 版本（避免兼容波动）
          dir: ${{ github.workspace }}/Qt
          timeout-minutes: 15  # 延长超时，应对网络波动

      # 3. 配置 CMake（按平台选择预设）
      - name: Configure CMake
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            macos-latest) PRESET="macos-release" ;;
            windows-latest) PRESET="win-release" ;;
            ubuntu-latest) PRESET="linux-release" ;;
          esac
          cmake --preset=$PRESET

      # 4. 构建项目
      - name: Build project
        shell: bash
        run: cmake --build build --config Release --parallel 4

      # 5. Linux 安装运行依赖（避免缺失库报错）
      - name: Install runtime dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libgl1-mesa-glx

      # 6. 运行 - macOS
      - name: "Run application (macOS)"
        if: runner.os == 'macOS'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 7. 运行 - Linux
      - name: "Run application (Linux)"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 8. 运行 - Windows
      - name: "Run application (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $EXEC_PATH = ".\build\Release\QtVsCodeTemplate.exe"
          & $EXEC_PATH
