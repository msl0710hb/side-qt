name: Qt 6.9.2 源码编译 CI（全平台终极兼容）
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          - os: macos-latest
            qt_src: qt-everywhere-src-6.9.2.tar.xz
            official_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/
            extract_cmd: tar -xf
            qt_install_dir: ${{ github.workspace }}/qt-6.9.2-install
            cmake_preset: macos-release
          - os: windows-latest
            qt_src: qt-everywhere-src-6.9.2.zip
            official_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/
            extract_cmd: 7z x -aoa -bd
            qt_install_dir: ${{ github.workspace }}\qt-6.9.2-install
            cmake_preset: win-release
          - os: ubuntu-latest
            qt_src: qt-everywhere-src-6.9.2.tar.xz
            official_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/
            extract_cmd: tar -xf
            qt_install_dir: ${{ github.workspace }}/qt-6.9.2-install
            cmake_preset: linux-release
    runs-on: ${{ matrix.os }}
    env:
      # 强制禁用 CI 缓存（避免残留污染）
      RUNNER_DISABLE_CACHE: true

    steps:
      - name: 检出项目源代码
        uses: actions/checkout@v4

      # 关键修复：彻底清理所有残留（核心解决“之前能跑现在不能跑”）
      - name: 深度清理残留（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          sudo rm -rf build/ ${{ matrix.qt_src }} qt-everywhere-src-6.9.2/ ${{ matrix.qt_install_dir }}
          sudo rm -rf ~/.cmake/ ~/.cache/ /tmp/*
          sudo rm -rf /usr/local/lib/cmake/Qt6*
          echo "已彻底清理残留文件和缓存"

      - name: 深度清理残留（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $dirsToRemove = @(
            "build", "${{ matrix.qt_src }}", "qt-everywhere-src-6.9.2", "${{ matrix.qt_install_dir }}",
            "$env:USERPROFILE\.cmake", "$env:USERPROFILE\.cache", "$env:TEMP\*",
            "C:\Program Files\CMake\share\cmake-*\Modules\FindQt6.cmake"
          )
          foreach ($dir in $dirsToRemove) {
            if (Test-Path $dir) {
              Remove-Item -Path $dir -Recurse -Force -ErrorAction SilentlyContinue
            }
          }
          Write-Host "已彻底清理残留文件和缓存"

      # 1. 安装依赖（补充缺失+版本锁定）
      - name: 安装依赖（Ubuntu）
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake=3.22.* ninja-build=1.10.* python3=3.10.* \
            libgl1-mesa-dev libxkbcommon-dev libxkbcommon-x11-dev \
            libxcb-randr0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xf86vidmode0-dev \
            libxcb-xinerama0-dev libxcb-icccm4-dev libxcb-keysyms1-dev \
            libxcb-image0-dev libxcb-util0-dev libxcb-xinput-dev libxcb-xfixes0-dev \
            libxcb-xkb-dev flex bison gperf libicu-dev libxslt-dev ruby \
            libssl-dev libfontconfig1-dev libfreetype6-dev libx11-dev libxext-dev \
            libxfixes-dev libxi-dev libxrender-dev libxcb1-dev libx11-xcb-dev \
            libxcb-glx0-dev zlib1g-dev

      - name: 安装依赖（macOS）
        if: matrix.os == 'macos-latest'
        run: |
          xcode-select --install || true
          brew install cmake@3.22 ninja@1.10 python3@3.10 pkg-config
          brew link --force cmake@3.22 ninja@1.10 python3@3.10

      - name: 安装依赖（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install cmake --version=3.22.6 -y
          choco install ninja --version=1.10.2 -y
          choco install python3 --version=3.10.11 -y
          choco install 7zip --version=22.1 -y
          # 固定7-Zip路径
          $7zipPath = "C:\Program Files\7-Zip"
          if (-not (Test-Path $7zipPath)) { $7zipPath = "C:\Program Files (x86)\7-Zip" }
          echo "$7zipPath" >> $env:GITHUB_PATH
          echo "CMAKE_PREFIX_PATH=C:\Program Files\CMake\bin" >> $env:GITHUB_ENV

      # 2. 下载Qt源码（优化稳定性）
      - name: 下载 Qt 6.9.2 源码（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          wget -c --tries=10 --timeout=1800 ${{ matrix.official_url }}${{ matrix.qt_src }} -O ${{ matrix.qt_src }}
          FILE_SIZE=$(du -sb ${{ matrix.qt_src }} | awk '{print $1}')
          [ $FILE_SIZE -ge 1000000000 ] || { echo "源码包不完整"; exit 1; }

      - name: 下载 Qt 6.9.2 源码（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $outputFile = "${{ matrix.qt_src }}"
          $url = "${{ matrix.official_url }}${{ matrix.qt_src }}"
          Invoke-WebRequest -Uri $url -OutFile $outputFile -UseBasicParsing -MaximumRetryCount 8 -RetryIntervalSec 15
          (Get-Item $outputFile).Length -ge 1000000000 || { throw "源码包不完整"; }

      # 3. 解压+配置+编译（简化逻辑，减少出错点）
      - name: 解压+配置+编译+安装（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          ${{ matrix.extract_cmd }} ${{ matrix.qt_src }}
          cd qt-everywhere-src-6.9.2
          ./configure -prefix ${{ matrix.qt_install_dir }} -release -opensource -confirm-license -nomake examples -nomake tests -skip qtwebengine -- -GNinja
          cmake --build . --parallel 2
          cmake --install .

      - name: 解压+配置+编译+安装（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          & ${{ matrix.extract_cmd }} ${{ matrix.qt_src }}
          cd qt-everywhere-src-6.9.2
          .\configure.bat -prefix "${{ matrix.qt_install_dir }}" -release -opensource -confirm-license -nomake examples -nomake tests -skip qtwebengine -- -GNinja
          cmake --build . --parallel 2
          cmake --install .

      # 4. 配置Qt环境（强制指定路径）
      - name: 配置Qt环境（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          echo "Qt6_DIR=${{ matrix.qt_install_dir }}/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "${{ matrix.qt_install_dir }}/bin" >> $GITHUB_PATH
          qmake --version || { echo "Qt环境失败"; exit 1; }

      - name: 配置Qt环境（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $qtDir = "${{ matrix.qt_install_dir }}"
          echo "Qt6_DIR=$qtDir\lib\cmake\Qt6" >> $env:GITHUB_ENV
          echo "$qtDir\bin" >> $env:GITHUB_PATH
          qmake --version || { Write-Error "Qt环境失败"; exit 1; }

      # 5. 构建+运行dayN工程（容错+明确路径）
      - name: 构建+运行工程（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          PROJECTS=$(find . -maxdepth 1 -type d -iregex './day[0-9]+' | sed 's|^\./||' | sort -V)
          [ -z "$PROJECTS" ] && { echo "无匹配工程"; exit 0; }
          for proj in $PROJECTS; do
            echo -e "\n===== 构建 $proj ====="
            mkdir -p build/$proj
            cmake -S $proj -B build/$proj -DCMAKE_BUILD_TYPE=Release -DQt6_DIR=${{ matrix.qt_install_dir }}/lib/cmake/Qt6
            cmake --build build/$proj --parallel 2
            # 运行可执行文件
            EXEC=$(find build/$proj -name "$proj" -type f -executable | head -1)
            if [ -n "$EXEC" ]; then
              chmod +x $EXEC
              $EXEC || echo "$proj 运行返回非零"
            else
              echo "$proj 未找到可执行文件"
            fi
          done

      - name: 构建+运行工程（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $projects = Get-ChildItem -Directory -Path . | Where-Object { $_.Name -match '^day\d+$' } | Select-Object -ExpandProperty Name
          if (-not $projects) { Write-Host "无匹配工程"; exit 0; }
          foreach ($proj in $projects) {
            Write-Host "`n===== 构建 $proj ====="
            mkdir -p build/$proj
            cmake -S $proj -B build/$proj -DCMAKE_BUILD_TYPE=Release -DQt6_DIR="${{ matrix.qt_install_dir }}\lib\cmake\Qt6"
            cmake --build build/$proj --parallel 2
            # 运行可执行文件
            $exec = Get-ChildItem -Path build/$proj -Filter "$proj.exe" -Recurse -File | Select-Object -First 1
            if ($exec) {
              & $exec.FullName
              if ($LASTEXITCODE -ne 0) { Write-Warning "$proj 运行返回非零" }
            } else {
              Write-Warning "$proj 未找到可执行文件"
            }
          }