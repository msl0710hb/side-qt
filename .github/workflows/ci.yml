name: Qt Build CI
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4

      - name: 2. 安装基础依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build python3 wget zlib1g-dev libgl1-mesa-dev

      - name: 3. 下载 Qt 6.9.2 源码
        run: wget -c https://download.qt.io/archive/qt/6.9/6.9.2/single/qt-everywhere-src-6.9.2.tar.xz -O qt.tar.xz --timeout=600

      - name: 4. 解压源码
        run: tar -xf qt.tar.xz && cd qt-everywhere-src-6.9.2 && echo "QT_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 5. 配置 Qt 编译
        run: |
          cd ${{ env.QT_DIR }}
          ./configure -prefix $GITHUB_WORKSPACE/qt-install -release -opensource -confirm-license -nomake examples -nomake tests -skip qtdeclarative -skip qtwebengine -- -GNinja

      - name: 6. 编译安装 Qt
        run: |
          cd ${{ env.QT_DIR }}
          cmake --build . --parallel 2
          cmake --install .

      - name: 7. 构建 dayN 工程
        run: |
          export Qt6_DIR=$GITHUB_WORKSPACE/qt-install/lib/cmake/Qt6
          for proj in $(find . -maxdepth 1 -type d -name "day[0-9]*"); do
            echo "构建 $proj"
            mkdir -p $proj/build
            cmake -S $proj -B $proj/build -DCMAKE_PREFIX_PATH=$Qt6_DIR
            cmake --build $proj/build --parallel 2
          done