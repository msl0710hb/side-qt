name: Qt macOS Build
on: [push, pull_request]

jobs:
  build-macos:
    runs-on: macos-14  # 推荐使用较新的 macOS 镜像
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.2'  # 与你的 Qt 版本一致
          host: 'macos'
          target: 'desktop'
          arch: 'clang_64'
          install-deps: true  # 自动安装依赖
          cache: true  # 缓存 Qt 安装包，加速后续构建

      - name: Configure Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode_16.4.app/Contents/Developer  # 匹配日志中的 Xcode 版本
          xcodebuild -version  # 验证 Xcode 配置

      - name: Create build directory
        run: mkdir -p build/day0-build && cd build/day0-build

      - name: CMake Configure
        run: |
          cd build/day0-build
          cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \  # 关键：指定 Qt 安装路径
            -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \  # 保留双架构
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \  # 匹配日志中的最低版本
            ../../  # 你的 CMakeLists.txt 所在路径

      - name: Build
        run: |
          cd build/day0-build
          make -j$(sysctl -n hw.ncpu)  # 多线程编译