name: Qt Cross-Platform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          #  Qt 6.2.4 官方安装包直链（各平台稳定可用）
          - os: macos-latest
            qt_url: "https://download.qt.io/archive/qt/6.2/6.2.4/qt-opensource-mac-x64-6.2.4.dmg"
            qt_install_dir: "/Users/runner/Qt/6.2.4/macos"
            qt_env_var: "QT_MACOS_DIR"
          - os: windows-latest
            qt_url: "https://download.qt.io/archive/qt/6.2/6.2.4/qt-opensource-windows-x86_64-6.2.4.exe"
            qt_install_dir: "C:\\Qt\\6.2.4\\msvc2019_64"
            qt_env_var: "QT_WINDOWS_DIR"
          - os: ubuntu-latest
            qt_url: "https://download.qt.io/archive/qt/6.2/6.2.4/qt-opensource-linux-x64-6.2.4.run"
            qt_install_dir: "/home/runner/Qt/6.2.4/gcc_64"
            qt_env_var: "QT_LINUX_DIR"
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # 1. 安装依赖工具（解压/下载）
      - name: Install dependencies
        shell: bash
        run: |
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            brew install wget 7zip
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            choco install wget 7zip -y
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            sudo apt-get update && sudo apt-get install -y wget p7zip-full
          fi
          
      # 2. 下载 Qt 官方安装包
      - name: Download Qt 6.2.4
        shell: bash
        run: |
          wget -c ${{ matrix.qt_url }} -O qt_installer.${{ matrix.os == 'macos-latest' && 'dmg' || matrix.os == 'windows-latest' && 'exe' || 'run' }}
          
      # 3. 解压/安装 Qt（无交互，静默安装）
      - name: Extract/Install Qt
        shell: bash
        run: |
          mkdir -p ${{ matrix.qt_install_dir }}
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            # 挂载 dmg 并复制文件
            hdiutil attach qt_installer.dmg -mountpoint /Volumes/QtInstaller
            cp -R /Volumes/QtInstaller/Qt\ 6.2.4/*.app/Contents/MacOS/* ${{ matrix.qt_install_dir }}
            hdiutil detach /Volumes/QtInstaller
          elif [ "${{ matrix.os }}" = "windows-latest" ]; then
            # 静默安装 EXE
            ./qt_installer.exe --script <(echo 'InstallDir="${{ matrix.qt_install_dir }}"; Components="qt.qt6.240.win64_msvc2019_64";') -platform minimal
          elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            # 赋予执行权限并静默安装
            chmod +x qt_installer.run
            ./qt_installer.run --script <(echo 'InstallDir="${{ matrix.qt_install_dir }}"; Components="qt.qt6.240.linux64_gcc_64";') -platform minimal
          fi
          
      # 4. 设置 Qt6_DIR 环境变量（供 CMake 识别）
      - name: Set Qt6_DIR
        shell: bash
        run: |
          echo "Qt6_DIR=${{ matrix.qt_install_dir }}" >> $GITHUB_ENV
          
      # 5. 配置 CMake
      - name: Configure CMake
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            macos-latest) PRESET="macos-release" ;;
            windows-latest) PRESET="win-release" ;;
            ubuntu-latest) PRESET="linux-release" ;;
          esac
          cmake --preset=$PRESET
          
      # 6. 构建项目
      - name: Build project
        shell: bash
        run: cmake --build build --config Release --parallel 4
          
      # 7. Linux 运行依赖
      - name: Install runtime dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libgl1-mesa-glx libxcb-icccm4 libxcb-image0
          
      # 8. 运行 - macOS
      - name: "Run application (macOS)"
        if: runner.os == 'macOS'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH
          
      # 9. 运行 - Linux
      - name: "Run application (Linux)"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH
          
      # 10. 运行 - Windows
      - name: "Run application (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $EXEC_PATH = ".\build\Release\QtVsCodeTemplate.exe"
          & $EXEC_PATH
