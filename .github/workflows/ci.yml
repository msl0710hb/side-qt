name: Qt Cross-Platform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          # 选用 Qt 6.2.4 LTS（跨平台包最稳定，无 qt_base 缺失问题）
          - os: macos-latest
            qt_version: '6.2.4'
            qt_arch: 'clang_64'
          - os: windows-latest
            qt_version: '6.2.4'
            qt_arch: 'win64_msvc2019_64'  # 6.2.4 对应 MSVC 2019 架构（兼容性更广）
          - os: ubuntu-latest
            qt_version: '6.2.4'
            qt_arch: 'gcc_64'
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # 修复 Windows Python 权限警告：手动指定 Python 路径
      - name: Set Python path (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          echo "PYTHONPATH=C:\hostedtoolcache\windows\Python\3.11.9\x64" >> $env:GITHUB_ENV
          echo "PATH=C:\hostedtoolcache\windows\Python\3.11.9\x64;$env:PATH" >> $env:GITHUB_ENV

      # 极简 Qt 安装（仅保留核心参数，避免冲突）
      - name: Install Qt ${{ matrix.qt_version }}
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ matrix.qt_version }}
          arch: ${{ matrix.qt_arch }}
          cache: true
          aqtversion: '==3.1.10'  # 锁定更稳定的 aqtinstall 旧版本（适配 Qt 6.2.4）
          dir: ${{ github.workspace }}/Qt
          modules: 'qtbase'  # 强制安装核心模块，避免包缺失

      # 配置 CMake
      - name: Configure CMake
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            macos-latest) PRESET="macos-release" ;;
            windows-latest) PRESET="win-release" ;;
            ubuntu-latest) PRESET="linux-release" ;;
          esac
          cmake --preset=$PRESET

      # 构建项目
      - name: Build project
        shell: bash
        run: cmake --build build --config Release --parallel 4

      # Linux 运行依赖
      - name: Install runtime dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libgl1-mesa-glx libxcb-icccm4 libxcb-image0

      # 运行 - macOS
      - name: "Run application (macOS)"
        if: runner.os == 'macOS'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 运行 - Linux
      - name: "Run application (Linux)"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 运行 - Windows
      - name: "Run application (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $EXEC_PATH = ".\build\Release\QtVsCodeTemplate.exe"
          & $EXEC_PATH
