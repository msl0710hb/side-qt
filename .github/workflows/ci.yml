name: Qt Cross-Platform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
        include:
          - os: macos-latest
            qt_arch: clang_64
            qt_version: '6.5.3'
          - os: windows-latest
            qt_arch: win64_msvc2022_64
            qt_version: '6.5.3'
          - os: ubuntu-latest
            qt_arch: gcc_64
            qt_version: '6.5.3'
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      # 安装 Qt 6.5.3 LTS（稳定无包缺失问题）
      - name: Install Qt ${{ matrix.qt_version }}
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ matrix.qt_version }}
          arch: ${{ matrix.qt_arch }}
          cache: true
          aqtversion: '==3.1.21'
          dir: ${{ github.workspace }}/Qt
          # 移除无效的 timeout-minutes 参数，避免警告

      # 配置 CMake
      - name: Configure CMake
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            macos-latest) PRESET="macos-release" ;;
            windows-latest) PRESET="win-release" ;;
            ubuntu-latest) PRESET="linux-release" ;;
          esac
          cmake --preset=$PRESET

      # 构建项目
      - name: Build project
        shell: bash
        run: cmake --build build --config Release --parallel 4

      # Linux 安装运行依赖
      - name: Install runtime dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libgl1-mesa-glx libxcb-icccm4 libxcb-image0

      # 运行 - macOS
      - name: "Run application (macOS)"
        if: runner.os == 'macOS'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 运行 - Linux
      - name: "Run application (Linux)"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH
          $EXEC_PATH

      # 运行 - Windows
      - name: "Run application (Windows)"
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $EXEC_PATH = ".\build\Release\QtVsCodeTemplate.exe"
          & $EXEC_PATH
