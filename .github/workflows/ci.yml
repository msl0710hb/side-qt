# 文件名：.github/workflows/qt-6.9.2-prebuilt-ci.yml
name: Qt 6.9.2 预编译包 CI（全平台极速版）

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
        include:
          - os: ubuntu-latest
            qt_ver: 6.9.2
            qt_arch: gcc_64
            qt_host: linux
            preset: linux-release
            qt_dir: ${{ github.workspace }}/Qt
          - os: windows-latest
            qt_ver: 6.9.2
            qt_arch: win64_msvc2022_64   # ← 6.9 起官方只有 2022 64 位包
            qt_host: windows
            preset: win-release
            qt_dir: ${{ github.workspace }}\Qt
          - os: macos-latest
            qt_ver: 6.9.2
            qt_arch: clang_64
            qt_host: mac
            preset: macos-release
            qt_dir: ${{ github.workspace }}/Qt

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: 安装 aqtinstall
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall

      - name: 缓存 Qt
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: ${{ matrix.qt_dir }}
          key: qt-${{ matrix.qt_ver }}-${{ matrix.os }}-${{ matrix.qt_arch }}

      - name: Install Qt ${{ matrix.qt_ver }}
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          aqt install-qt ${{ matrix.qt_host }} desktop ${{ matrix.qt_ver }} ${{ matrix.qt_arch }} \
            --outputdir "${{ matrix.qt_dir }}"

      - name: 配置环境
        shell: bash
        run: |
          echo "${{ matrix.qt_dir }}/${{ matrix.qt_ver }}/${{ matrix.qt_arch }}/bin" >> $GITHUB_PATH
          echo "Qt6_DIR=${{ matrix.qt_dir }}/${{ matrix.qt_ver }}/${{ matrix.qt_arch }}/lib/cmake/Qt6" >> $GITHUB_ENV

      - name: 装构建工具
        uses: lukka/get-cmake@latest

      - name: 识别 dayN 工程
        id: proj
        shell: bash
        run: |
          projects=($(find . -maxdepth 1 -type d -name 'day[0-9]*' | sed 's|^\./||' | sort -V))
          echo "list=${projects[*]}" >> $GITHUB_OUTPUT

      - name: 批量构建
        if: steps.proj.outputs.list != ''
        shell: bash
        run: |
          for proj in ${{ steps.proj.outputs.list }}; do
            cmake --preset=${{ matrix.preset }} -S "$proj" -B "build/$proj"
            cmake --build "build/$proj" --config Release --parallel $(nproc 2>/dev/null || sysctl -n hw.ncpu || echo 4)
          done

      - name: 运行验证
        if: steps.proj.outputs.list != ''
        shell: bash
        run: |
          for proj in ${{ steps.proj.outputs.list }}; do
            exe=$(find "build/$proj" -type f -executable -name "$proj*" | head -n1)
            [[ -x "$exe" ]] && { echo "==== 运行 $proj ===="; "$exe" || echo "运行失败（非致命）"; }
          done
