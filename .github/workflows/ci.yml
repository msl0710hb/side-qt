name: Qt Cross-Platform CI

# è§¦å‘æ¡ä»¶ï¼šmain åˆ†æ”¯çš„ push å’Œ pull request
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-run:
    strategy:
      # å¤šå¹³å°çŸ©é˜µï¼šè¦†ç›–ä¸‰å¤§ä¸»æµç³»ç»Ÿ
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. åŠ¨æ€æŸ¥è¯¢ Qt 6.9.2 é€‚é…æ¶æ„ï¼ˆå½»åº•ä¿®å¤å­—ç¬¦æ•°ç»„é—®é¢˜ï¼‰
      - name: Detect Qt architecture
        id: qt_arch
        shell: pwsh
        run: |
          # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ aqtinstallï¼ˆQt å®‰è£…å·¥å…·ï¼‰
          python -m pip install -q aqtinstall==3.1.*
          
          # ç³»ç»Ÿæ˜ å°„ï¼šåŒ¹é… aqtinstall æ‰€éœ€çš„ä¸»æœºåæ ¼å¼
          $hostMap = @{
            'Windows' = 'windows'
            'macOS'   = 'mac'
            'Linux'   = 'linux'
          }
          $hostName = $hostMap[$Env:RUNNER_OS]
          
          # æ‰§è¡Œ aqt å‘½ä»¤æŸ¥è¯¢æ¶æ„ï¼Œå¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²é¿å…å­—ç¬¦æ•°ç»„è§£æ
          $output = [string](python -m aqt list-qt $hostName desktop --arch 6.9.2)
          
          # åˆ†å‰²æ¢è¡Œç¬¦ï¼Œè¿‡æ»¤ç©ºè¡Œ/çº¯ç©ºæ ¼è¡Œï¼Œå¼ºåˆ¶å£°æ˜ä¸ºæ•°ç»„
          $archList = @($output -split "`r?`n" | Where-Object { $_ -match '\S' })
          
          # æ ¡éªŒæ¶æ„åˆ—è¡¨æœ‰æ•ˆæ€§
          if (-not $archList -or $archList.Count -eq 0) {
            throw "No valid architecture found for Qt 6.9.2 on $hostName (OS: ${{ matrix.os }})"
          }
          
          # å®‰å…¨è·å–ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ¶æ„ï¼ˆé¿å…å­—ç¬¦æ•°ç»„é—®é¢˜ï¼‰
          $arch = $archList | Select-Object -First 1
          $arch = $arch.Trim()
          
          # è¾“å‡ºæ—¥å¿—ä¾¿äºè°ƒè¯•ï¼Œå†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          Write-Host "âœ… Detected Qt architecture for ${{ matrix.os }}: $arch"
          Write-Output "arch=$arch" >> $Env:GITHUB_OUTPUT

      # 3. å®‰è£… Qt 6.9.2ï¼ˆé”å®šç‰ˆæœ¬ï¼Œç¼“å­˜åŠ é€Ÿï¼‰
      - name: Install Qt 6.9.2
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.9.2'          # ä¸æŸ¥è¯¢æ¶æ„çš„ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
          arch: ${{ steps.qt_arch.outputs.arch }} # ä»…ä¼ é€’å•ä¸ªæœ‰æ•ˆæ¶æ„
          cache: true               # å¼€å¯ç¼“å­˜ï¼ŒåŠ é€Ÿåç»­æ„å»º
          aqtversion: '==3.1.*'     # é”å®š aqtinstall ç‰ˆæœ¬ï¼Œé¿å…å…¼å®¹æ³¢åŠ¨
          dir: ${{ github.workspace }}/Qt # Qt å®‰è£…ç›®å½•ï¼ˆç»Ÿä¸€è·¯å¾„ï¼‰

      # 4. CMake é…ç½®ï¼ˆè·¨å¹³å°é¢„è®¾é€‚é…ï¼‰
      - name: Configure CMake
        shell: pwsh
        run: |
          # æ ¹æ®ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„ CMake é¢„è®¾
          switch -Wildcard ('${{ matrix.os }}') {
            'windows-latest' { $preset = 'win-release' }
            'macos-latest'   { $preset = 'macos-release' }
            'ubuntu-latest'  { $preset = 'linux-release' }
            default { throw "âŒ Unsupported OS: ${{ matrix.os }}" }
          }
          
          # æ‰§è¡Œ CMake é…ç½®
          Write-Host "ğŸ”§ Configuring CMake with preset: $preset"
          cmake --preset=$preset

      # 5. æ„å»ºé¡¹ç›®ï¼ˆæŒ‡å®š Release æ¨¡å¼ï¼Œç¡®ä¿äº§ç‰©ä¼˜åŒ–ï¼‰
      - name: Build project
        shell: pwsh
        run: |
          Write-Host "ğŸ—ï¸ Building project for ${{ matrix.os }}"
          cmake --build build --config Release --parallel 4 # å¹¶è¡Œæ„å»ºåŠ é€Ÿ

      # 6. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼ˆè·¨å¹³å°è·¯å¾„é€‚é…ï¼‰
      - name: Run application (Unix: macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Unix å¹³å°äº§ç‰©è·¯å¾„ï¼šbuild/Release/å¯æ‰§è¡Œæ–‡ä»¶
          EXEC_PATH="./build/Release/QtVsCodeTemplate"
          chmod +x $EXEC_PATH # ç¡®ä¿å¯æ‰§è¡Œæƒé™
          echo "â–¶ï¸ Running application: $EXEC_PATH"
          $EXEC_PATH

      - name: Run application (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Windows å¹³å°äº§ç‰©è·¯å¾„ï¼šbuild\Release\å¯æ‰§è¡Œæ–‡ä»¶.exe
          $EXEC_PATH = ".\build\Release\QtVsCodeTemplate.exe"
          echo "â–¶ï¸ Running application: $EXEC_PATH"
          & $EXEC_PATH
