name: Qt 6.9.2 跨平台编译 CI（终极稳定版）
on:
  push:
    branches: [ main ]
    paths:
      - 'day*/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'day*/**'
      - '.github/workflows/ci.yml'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          # 平台专属配置（官方链接+适配命令）
          - os: ubuntu-latest
            qt_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/qt-everywhere-src-6.9.2.tar.xz
            qt_file: qt-src.tar.xz
            extract_cmd: tar -xf
            qt_install: ${{ github.workspace }}/qt-install
          - os: windows-latest
            qt_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/qt-everywhere-src-6.9.2.zip
            qt_file: qt-src.zip
            extract_cmd: 7z x -aoa -bd
            qt_install: ${{ github.workspace }}\qt-install
          - os: macos-latest
            qt_url: https://download.qt.io/archive/qt/6.9/6.9.2/single/qt-everywhere-src-6.9.2.tar.xz
            qt_file: qt-src.tar.xz
            extract_cmd: tar -xf
            qt_install: ${{ github.workspace }}/qt-install

    steps:
      # 1. 检出代码（强制追踪）
      - name: 检出项目源代码
        uses: actions/checkout@v4

      # 2. 安装依赖（精简核心依赖+清理缓存）
      - name: 安装依赖（Ubuntu）
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential cmake ninja-build python3 wget zlib1g-dev libgl1-mesa-dev libxkbcommon-dev libxcb-xkb-dev
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

      - name: 安装依赖（macOS）
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake ninja python3 pkg-config
          brew cleanup

      - name: 安装依赖（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install cmake ninja python3 7zip -y
          echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH

      # 3. 下载 Qt 源码（跨平台命令适配）
      - name: 下载 Qt 6.9.2（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: wget -c --tries=3 ${{ matrix.qt_url }} -O ${{ matrix.qt_file }} --timeout=600

      - name: 下载 Qt 6.9.2（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri ${{ matrix.qt_url }} -OutFile ${{ matrix.qt_file }} -UseBasicParsing
          $fileSize = (Get-Item ${{ matrix.qt_file }}).Length
          if ($fileSize -lt 1000000000) { throw "源码下载不完整" }

      # 4. 解压源码（路径规范化）
      - name: 解压 Qt 源码（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          ${{ matrix.extract_cmd }} ${{ matrix.qt_file }}
          cd qt-everywhere-src-6.9.2
          echo "QT_DIR=$(pwd)" >> $GITHUB_ENV

      - name: 解压 Qt 源码（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          ${{ matrix.extract_cmd }} ${{ matrix.qt_file }}
          cd qt-everywhere-src-6.9.2
          echo "QT_DIR=$(Get-Location | Select-Object -ExpandProperty Path)" >> $env:GITHUB_ENV

      # 5. 配置 Qt 编译（核心模块+磁盘优化）
      - name: 配置 Qt（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          cd ${{ env.QT_DIR }}
          ./configure \
            -prefix ${{ matrix.qt_install }} \
            -release -opensource -confirm-license \
            -nomake examples -nomake tests -nomake tools \
            -skip qtdeclarative -skip qtwebengine -skip qt3d -skip qtcharts \
            -skip qtmultimedia -skip qtsvg -skip qttools \
            -- -GNinja

      - name: 配置 Qt（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd $env:QT_DIR
          .\configure.bat `
            -prefix "${{ matrix.qt_install }}" `
            -release -opensource -confirm-license `
            -nomake examples -nomake tests -nomake tools `
            -skip qtdeclarative -skip qtwebengine -skip qt3d -skip qtcharts `
            -skip qtmultimedia -skip qtsvg -skip qttools `
            -- -GNinja

      # 6. 编译安装 Qt（限制并行线程）
      - name: 编译安装 Qt（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          cd ${{ env.QT_DIR }}
          cmake --build . --parallel 2
          cmake --install .

      - name: 编译安装 Qt（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd $env:QT_DIR
          cmake --build . --parallel 2
          cmake --install .

      # 7. 配置项目环境变量
      - name: 配置环境（Linux/macOS）
        if: matrix.os != 'windows-latest'
        run: |
          echo "Qt6_DIR=${{ matrix.qt_install }}/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "${{ matrix.qt_install }}/bin" >> $GITHUB_PATH

      - name: 配置环境（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          echo "Qt6_DIR=${{ matrix.qt_install }}\lib\cmake\Qt6" >> $env:GITHUB_ENV
          echo "${{ matrix.qt_install }}\bin" >> $env:GITHUB_PATH

      # 8. 批量构建 dayN 工程（自动识别+容错）
      - name: 构建 dayN 工程（Linux/macOS）
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          PROJECTS=$(find . -maxdepth 1 -type d -name "day[0-9]*" | sort -V)
          if [ -z "$PROJECTS" ]; then echo "无 dayN 工程，跳过"; exit 0; fi
          for proj in $PROJECTS; do
            echo -e "\n===== 构建工程：$proj ====="
            mkdir -p $proj/build
            cmake -S $proj -B $proj/build -DCMAKE_BUILD_TYPE=Release
            cmake --build $proj/build --parallel 2
          done

      - name: 构建 dayN 工程（Windows）
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $projects = Get-ChildItem -Directory -Path . -Filter "day[0-9]*" | Select-Object -ExpandProperty Name | Sort-Object { [int]($_.Replace('day', '')) }
          if ($projects.Count -eq 0) { Write-Host "无 dayN 工程，跳过"; exit 0; }
          foreach ($proj in $projects) {
            Write-Host "`n===== 构建工程：$proj ====="
            mkdir -p $proj/build
            cmake -S $proj -B $proj/build -DCMAKE_BUILD_TYPE=Release
            cmake --build $proj/build --config Release --parallel 2
          }